---
title: CSAPP-BOMB-LAB
date: 2018-3-26
categories: 
        - ç¨‹åºè®¾è®¡
        - æ±‡ç¼–
tags: [é€†å‘,æ±‡ç¼–]
keywords: asm,x86, é€†å‘å·¥ç¨‹ï¼Œgdb
description: "csapp-bomb-lab-writeup"
top:

---

è¿™æ˜¯ 2016 ç‰ˆçš„ bomb

ä¸‹è½½å¾—åˆ° bomb.tar æ–‡ä»¶ï¼Œè§£å‹ååªæœ‰ bomb äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä»¥åŠä¸€ä¸ª bomb.c æ–‡ä»¶ï¼Œbomb.c æ²¡æœ‰å¯¹åº”çš„å¤´æ–‡ä»¶ã€‚æ‰€æœ‰æ€è·¯åªæœ‰æ˜¯åæ±‡ç¼– bomb, åˆ†ææ±‡ç¼–ä»£ç ã€‚

è¿™é‡Œç”¨åˆ°ä¸¤ä¸ªéå¸¸å¼ºå¤§çš„å·¥å…· objdump,gdb
* objdump ç”¨æ¥åæ±‡ç¼–çš„ï¼Œ-d å‚æ•°å¾—åˆ° x86 æ±‡ç¼–ï¼Œ-M å‚æ•°è¿˜å¯ä»¥é€‰æ‹©ä¸åŒçš„æ±‡ç¼–å½¢å¼ï¼Œæ¯”å¦‚ -M 8086 å¾—åˆ° 8086 æ±‡ç¼–ï¼Œè¯¦ç»†å†…å®¹å¯ä»¥ man objdump.
* gdb æ˜¯å¼ºå¤§çš„ GNU DEBUGGER  ç”¨æ³•å¦‚ä¸‹

```
    (gdb) bï¼ˆbreakpointï¼‰: ç”¨æ³•ï¼šb å‡½æ•°å ï¼šå¯¹æ­¤å‡½æ•°è¿›è¡Œä¸­æ–­ ï¼›b æ–‡ä»¶åï¼šè¡Œå·ï¼›
    (gdb) runï¼šå¯åŠ¨ç¨‹åºï¼Œè¿è¡Œè‡³ç¨‹åºçš„æ–­ç‚¹æˆ–è€…ç»“æŸï¼›
    (gdb) l(list): ç”¨æ³•ï¼šl funcnameï¼Œåˆ¶å®šå‡½æ•°çš„æºç 
    (gdb) s(step): è¿›å…¥å‡½æ•°ï¼Œé€è¯­å¥è¿è¡Œï¼›
    (gdb) n(next): ä¸è¿›å…¥å‡½æ•°ï¼Œé€è¿‡ç¨‹è¿è¡Œï¼›
    (gdb) cï¼ˆcontinueï¼‰ï¼šç»§ç»­è¿è¡Œï¼Œè·³è‡³ä¸‹ä¸€ä¸ªæ–­ç‚¹ï¼›
    (gdb) pï¼ˆprintï¼‰ï¼šæ‰“å°æ˜¾ç¤ºå˜é‡å€¼ï¼›
    (gdb) set variable=value, ä¸ºå˜é‡èµ‹å€¼ï¼›
    (gdb) killï¼šç»ˆæ­¢è°ƒè¯•çš„ç¨‹åºï¼›
    (gdb) hï¼ˆhelpï¼‰ï¼šåˆ—å‡º gdb è¯¦ç»†å‘½ä»¤å¸®åŠ©åˆ—è¡¨ï¼›
    (gdb) clear filename.c:30ï¼šæ¸…é™¤ 30 è¡Œå¤„çš„æ–­ç‚¹ï¼›
    (gdb) info breakï¼šæ˜¾ç¤ºæ–­ç‚¹ä¿¡æ¯ï¼›
    (gdb) delete æ–­ç‚¹ç¼–å·ï¼šæ–­ç‚¹ç¼–å·æ˜¯ info break åæ˜¾ç¤ºå‡ºæ¥çš„ï¼›
    (gdb) btï¼ˆbacktraceï¼‰ï¼šå›æº¯åˆ°æ®µå‡ºé”™çš„ä½ç½®ï¼›
    (gdb) frame å¸§å·ï¼šå¸§å·æ˜¯ bt å‘½ä»¤äº§ç”Ÿçš„å †æ ˆé’ˆï¼›
    (gdb) qï¼šé€€å‡ºï¼›
    (gdb) x(examine)ï¼šæŸ¥çœ‹å†…å­˜ä¸­çš„å€¼ç­‰ // è¯¦ç»†å†…å®¹åœ¨ gdb ä¸­è¾“å…¥ help x æŸ¥çœ‹
```
ä¸‹é¢å¼€å§‹æ‹† :bomb:  ä¹‹æ—…

## general
è§‚å¯Ÿæ±‡ç¼–ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°æœ‰ main, phase1--6, ç­‰ï¼Œé‡ç‚¹çœ‹è¿™å‡ ä¸ªå‡½æ•°ï¼Œä» main å¼€å§‹ï¼Œç»“åˆ bomb.c, å¯ä»¥æ˜ç™½ç¨‹åºçš„æ§åˆ¶æµï¼Œæ¯ä¸ªé˜¶æ®µç”¨ phase å‡½æ•°åˆ¤æ–­è¾“å…¥æ˜¯å¦æ­£ç¡®ï¼Œä¸æ­£ç¡®å°± boon, ç»“æŸç¨‹åº

![csapp-bomb-lab-report-1](https://raw.githubusercontent.com/mbinary/mbinary.github.io/hexo/source/images/csapp-bomb-lab-report-1.png)


## phase1
æ¥åˆ° phase1,

![csapp-bomb-lab-report-2](https://raw.githubusercontent.com/mbinary/mbinary.github.io/hexo/source/images/csapp-bomb-lab-report-2.png)


ç¬¬ä¸€è¡Œå‡†å¤‡æ ˆå¸§ï¼Œç¬¬äºŒè¡Œå°±æ˜¯å°†åœ°å€å­˜å…¥ $esi, è¿™æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²çš„åœ°å€ï¼Œå¯ä»¥çŒœæµ‹ä¸‹é¢ string_not_equal å°±æ˜¯æ¯”è¾ƒè¿™ä¸ªå­—ç¬¦ä¸²ä¸è¾“å…¥å­—ç¬¦ä¸²æ˜¯å¦ç›¸ç­‰çš„å‡½æ•°.ï¼ˆæœ€å¼€å§‹æˆ‘è¿˜å»åˆ†æäº†è¿™ä¸ªå‡½æ•°çš„æ±‡ç¼–ä»£ç ï¼Œç¡®å®æ˜¯é‚£æ ·ï¼Œå…ˆæ¯”è¾ƒé•¿åº¦ï¼Œç„¶åé€ä¸€æ¯”è¾ƒã€‚æ‰€ä»¥æ‰¾åˆ°è¿™ä¸ªåœ°å€`0x402400`å­˜å‚¨çš„å­—ç¬¦ä¸²å°±è¡Œäº†ï¼Œåœ¨ asm æ–‡ä»¶ä¸­æœç´¢ï¼Œæ²¡æœ‰ï¼Œæ‰€ä»¥è¦åœ¨ç¨‹åºè¿è¡Œæ—¶æ‰å¯ä»¥åˆ°è¾¾è¿™ä¸ªè™šæ‹Ÿåœ°å€ï¼Œæœªæ¥ address space çš„å †ä¸­ã€‚è¿™æ—¶å°±è¦ç”¨åˆ°å¼ºå¤§çš„ gdb äº†ï¼Œ

åˆ‡æ¢åˆ° bomb æ–‡ä»¶å¤¹ï¼Œä¾æ¬¡è¾“å…¥
```shell
gdb
(gdb) file bomb
(gdb) x /s 0x402400 # x(examine) s å‚æ•°æ˜¯ string çš„æ„æ€
```
å³å¾—**Border relations with Canada have never been better.**

## phase2
![csapp-bomb-lab-report-3](https://raw.githubusercontent.com/mbinary/mbinary.github.io/hexo/source/images/csapp-bomb-lab-report-3.png)


æ‰€ä»¥ç­”æ¡ˆæ˜¯ `1 2 4 8 16 32`

## phase3

```
  0000000000400f43 <phase_3>:
    400f43: sub    $0x18,%rsp
    400f47: lea    0xc(%rsp),%rcx
    400f4c: lea    0x8(%rsp),%rdx
    400f51: mov    $0x4025cf,%esi                     # åˆæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¯ä»¥ç”¨ gdb æŸ¥çœ‹ï¼Œå¾—åˆ°`"%d %d", æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œè¯´æ˜è¾“å…¥ä¸¤ä¸ªæ•°å­—
    400f56: mov    $0x0,%eax
    400f5b: callq  400bf0 <__isoc99_sscanf@plt>       # è¾“å…¥
    400f60: cmp    $0x1,%eax                           # åˆ¤æ–­è¾“å…¥æˆåŠŸ
    400f63: jg     400f6a <phase_3+0x27>
    400f65: callq  40143a <explode_bomb>
    400f6a: cmpl   $0x7,0x8(%rsp)                       # ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¦å°äºç­‰äº 7, å¤§äºåˆ™ boom
    400f6f: ja     400fad <phase_3+0x6a>
    400f71: mov    0x8(%rsp),%eax
    400f75: jmpq   *0x402470(,%rax,8)                 # ä»¥ä¸‹æ˜¯ switch, æ ¹æ® rax, å³ç¬¬ä¸€ä¸ªè¾“å…¥çš„å‚æ•°è·³è½¬
    400f7c: mov    $0xcf,%eax                          # ç”±æ­¤å®¹æ˜“å¾—åˆ°ç­”æ¡ˆï¼Œæ¯”å¦‚è¿™é‡Œæ˜¯ rax=0 æ—¶ï¼Œåˆ™ å¦ä¸€ä¸ªå‚æ•°ä¸º 0xcf  = 207
    400f81: jmp    400fbe <phase_3+0x7b>
    400f83: mov    $0x2c3,%eax
    400f88: jmp    400fbe <phase_3+0x7b>
    400f8a: mov    $0x100,%eax
    400f8f: jmp    400fbe <phase_3+0x7b>
    400f91: mov    $0x185,%eax
    400f96: jmp    400fbe <phase_3+0x7b>
    400f98: mov    $0xce,%eax
    400f9d: jmp    400fbe <phase_3+0x7b>
    400f9f: mov    $0x2aa,%eax
    400fa4: jmp    400fbe <phase_3+0x7b>
    400fa6: mov    $0x147,%eax
    400fab: jmp    400fbe <phase_3+0x7b>
    400fad: callq  40143a <explode_bomb>
    400fb2: mov    $0x0,%eax
    400fb7: jmp    400fbe <phase_3+0x7b>
    400fb9: mov    $0x137,%eax
    400fbe: cmp    0xc(%rsp),%eax
    400fc2: je     400fc9 <phase_3+0x86>
    400fc4: callq  40143a <explode_bomb>
    400fc9: add    $0x18,%rsp
    400fcd: retq
```
swith è·³è½¬è¡¨
%rax     è·³è½¬åœ°å€          0xc(%rsp)
0     0x0000000000400f7c    0xcf  207
1     0x0000000000400fb9    0x137 311
2     0x0000000000400f83    0x2c3 707
3     0x0000000000400f8a    0x100 256
4     0x0000000000400f91    0x185 389
5     0x0000000000400f98    0xce  206
6     0x0000000000400f9f    0x2aa 682
7     0x0000000000400fa6    0x147 327
æ‰€ä»¥ç»“æœä¸º`0 207` ...

## phase4

```
 000000000040100c <phase_4>:
   40100c:    sub    $0x18,%rsp
   401010:    lea    0xc(%rsp),%rcx
   401015:    lea    0x8(%rsp),%rdx
   40101a:    mov    $0x4025cf,%esi                 #åŒæ ·ï¼Œgdb ä¸­ x /s çŸ¥é“è¾“å…¥ä¸¤ä¸ªæ•°å­—
   40101f:    mov    $0x0,%eax
   401024:    callq  400bf0 <__isoc99_sscanf@plt>
   401029:    cmp    $0x2,%eax                      # åˆ¤æ–­æ˜¯å¦è¾“å…¥ä¸¤ä¸ªæ•°
   40102c:    jne    401035 <phase_4+0x29>
   40102e:    cmpl   $0xe,0x8(%rsp)                  # åˆ¤æ–­æ¯ä¸ªæ•°æ˜¯å¦â‰¤14 , å¤§äºåˆ™ boom
   401033:    jbe    40103a <phase_4+0x2e>           # è·³è½¬
   401035:    callq  40143a <explode_bomb>
   40103a:    mov    $0xe,%edx                       # æ„é€  func4 çš„å‚æ•° (phase4 è°ƒç”¨çš„ï¼‰
   40103f:    mov    $0x0,%esi                       # æ„é€  func4 çš„å‚æ•°
   401044:    mov    0x8(%rsp),%edi                   # æ„é€  func4 çš„å‚æ•°
   401048:    callq  400fce <func4>
   40104d:    test   %eax,%eax                       # æµ‹è¯•ï¼Œfunc4 è¿”å› 0, è‹¥ä¸ï¼Œåˆ™ boom
   40104f:    jne    401058 <phase_4+0x4c>
   401051:    cmpl   $0x0,0xc(%rsp)
   401056:    je     40105d <phase_4+0x51>
   401058:    callq  40143a <explode_bomb>
   40105d:    add    $0x18,%rsp
   401061:    retq
 ```
 å°† func4 è½¬æ¢ä¸º c è¯­è¨€ï¼Œå¹¶ç”¨ 0--14 æµ‹è¯•ï¼Œè¿™ç‚¹å¾ˆéš¾ï¼Œéœ€è¦ç¿»è¯‘æ±‡ç¼–è¯­è¨€ï¼ŒèŠ±å¾ˆå¤šæ—¶é—´ï¼Œå¾—ç†Ÿæ‚‰æ±‡ç¼–ä»£ç æ‰è¡Œ
 ```c
 int func4(int a, int b, int c)
{
    int result;
    result = c;
    result = result - b;
    int tmp = result;
    tmp = (unsigned)tmp >> 31;
    result = result + tmp;
    result = result / 2;
    tmp = result + b;
    if(tmp > a)
    {
        c = tmp - 1;
        result = func4(a, b, c);
        return (2 * result);
    }
    result = 0;
    if(tmp < a)
    {
        b = tmp + 1;
        result = func4(a, b, c);
        return (1 + 2 * result);
    }
    return result;
}
// æµ‹è¯•ä» 0~14 èŒƒå›´å†…æ»¡è¶³æ¡ä»¶çš„å€¼

int main()
{
    for(int input = 0; input < 15; ++input)
    {
        int result = func4(input, 0, 14);
        if(result == 0)
        {
            printf("input = %d, func4 = %d\n", input, result);
        }
    }
    return 0;
}

```
å¾—åˆ°å¯è¡Œè§£
å› æ­¤ phase4 å¯èƒ½ç»“æœä¸ºï¼š
0 0
1 0
3 0
7 0


## phase5
å—¯ï¼ŒåŠ æ²¹ï¼Œè¿˜æœ‰ä¸¤å…³äº†ã€‚(â—Ë‡Ë‡â—)
```asm
 0000000000401062 <phase_5>:
    401062:  push   %rbx
    401063:  sub    $0x20,%rsp
    401067:  mov    %rdi,%rbx
    40106a:  mov    %fs:0x28,%rax
    401071:
    401073:  mov    %rax,0x18(%rsp)
    401078:  xor    %eax,%eax
    40107a:  callq  40131b <string_length>
    40107f:  cmp    $0x6,%eax                 # è¯´æ˜è¾“å…¥æ˜¯å…­ä¸ªå­—ç¬¦
    401082:  je     4010d2 <phase_5+0x70>
    401084:  callq  40143a <explode_bomb>
    401089:  jmp    4010d2 <phase_5+0x70>
    40108b:  movzbl (%rbx,%rax,1),%ecx       # ä»æ ˆå¸§ä¸­å–å‡ºå„ä¸ªå­—ç¬¦ï¼Œè®°ä¸º x
    40108f:  mov    %cl,(%rsp)
    401092:  mov    (%rsp),%rdx
    401096:  and    $0xf,%edx                # y=0xf & x, å³å°†ä¸€ä¸ª byte çš„é«˜ 4 ä½ç½® 0
    401099:  movzbl 0x4024b0(%rdx),%edx       # ç”¨ gdb æŸ¥çœ‹ x /s 0x4024b0  å¾—åˆ°å­—ç¬¦ä¸²"maduiersnfotvbyl", æ‰€ä»¥è¿™ä¸€è¡Œæ˜¯ä»¥ y ä½œä¸ºåç§»é‡ï¼Œå–å­—ç¬¦æ•°ç»„çš„ç¬¬å‡ ä¸ªå­—ç¬¦
    4010a0:  mov    %dl,0x10(%rsp,%rax,1)     # å°†å–å¾—çš„å­˜äºæ ˆå¸§ä¸­ // åé¢ç”¨ string_not_equl æ¯”è¾ƒ
    4010a4:  add    $0x1,%rax
    4010a8:  cmp    $0x6,%rax                 # å¾ªç¯ 6 æ¬¡
    4010ac:  jne    40108b <phase_5+0x29>
    4010ae:  movb   $0x0,0x16(%rsp)
    4010b3:  mov    $0x40245e,%esi           # è¿™æ˜¯è¦æ¯”è¾ƒçš„å­—ç¬¦ä¸²ï¼ŒåŒæ ·ç”¨ gdb æŸ¥çœ‹å¾—åˆ° "flyers"
    4010b8:  lea    0x10(%rsp),%rdi
    4010bd:  callq  401338 <strings_not_equal>
    4010c2:  test   %eax,%eax
    4010c4:  je     4010d9 <phase_5+0x77>
    4010c6:  callq  40143a <explode_bomb>
    4010cb:  nopl   0x0(%rax,%rax,1)
    4010d0:  jmp    4010d9 <phase_5+0x77>
    4010d2:  mov    $0x0,%eax
    4010d7:  jmp    40108b <phase_5+0x29>
    4010d9:  mov    0x18(%rsp),%rax
    4010de:  xor    %fs:0x28,%rax
    4010e5:
    4010e7:  je     4010ee <phase_5+0x8c>
    4010e9:  callq  400b30 <__stack_chk_fail@plt>
    4010ee:  add    $0x20,%rsp
    4010f2:  pop    %rbx
    4010f3:  retq
 ```
 è§£é‡Šåœ¨ä¸Šé¢ï¼Œåå‘å¾—åˆ°éœ€è¦çš„è¾“å…¥çš„æ€è·¯æ˜¯ï¼šå¯¹ flyers çš„æ¯ä¸ªå­—ç¬¦ï¼Œå¾—åˆ°åœ¨å­—ç¬¦æ•°ç»„ä¸­çš„ index, ä¹Ÿå°±æ˜¯è¾“å…¥çš„å­—ç¬¦çš„å 4 ä½ bit, è€Œé”®ç›˜è¾“å…¥ä¸€èˆ¬æ˜¯å­—æ¯ï¼Œæ‰€ä»¥å¾ˆå¯èƒ½æœ‰ä¸¤ç§å¯èƒ½ï¼Œå­—ç¬¦ byte çš„é«˜å››ä½ä¸º`0100`æˆ–`0110`, è€Œä¸”å¯ä»¥å‘ç°åˆšå¥½è¿™æ˜¯å¤§å†™å­—æ¯ / å°å†™å­—æ¯å¼€å§‹çš„å‰ä¸€ä¸ª ascii, æ‰€ä»¥ç”¨ python ç®—ä¸€ä¸‹å³å¾—"ionefg"æˆ–æ˜¯"IONEFG"


```python
li = list('maduiersnfotvbyl)
s = ''.join([chr(li.index(i)+((1<<6)+(1<<5))) for i in 'flyers'])
print(s)
```

 ## phase6
 phase6 å¾ˆéš¾äº†ï¼Œè¿™çœŸçš„è¦ç†Ÿç»ƒæ±‡ç¼–è¯­è¨€ï¼Œæˆ‘ç¿»è¯‘åˆ°å‰é¢ï¼ŒçŸ¥é“è¾“å…¥çš„æ˜¯å…­ä¸ªä¸ç›¸åŒçš„æ•°å­—ï¼Œè€Œä¸”â‰¤6 ,~~æ‰€ä»¥å¯ä»¥è¯•å…¨æ’åˆ—äº†~~, åé¢çš„å®åœ¨çœ‹ä¸ä¸‹å»äº†ï¼Œåœ¨ç½‘ä¸Šæ‰¾åˆ°è¿™ä»½è§£æ
[è¿™æ˜¯é“¾æ¥](https://gitee.com/zhoulee/CSAPP/blob/master/bomb/phase_6.txt)

 ```
 (gdb) disas phase_6
Dump of assembler code for function phase_6:
   0x00000000004010f4 <+0>: push   %r14                                å°†è¢«è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨å‹å…¥æ ˆ
   0x00000000004010f6 <+2>: push   %r13
   0x00000000004010f8 <+4>: push   %r12
   0x00000000004010fa <+6>: push   %rbp
   0x00000000004010fb <+7>: push   %rbx                                %rsp = 0x7fffffffe2c0
   0x00000000004010fc <+8>: sub    $0x50,%rsp                          åˆ†é…æ ˆç©ºé—´ %rsp = 0x7fffffffe270
   0x0000000000401100 <+12>:    mov    %rsp,%r13

   0x0000000000401103 <+15>:    mov    %rsp,%rsi
   0x0000000000401106 <+18>:    callq  0x40145c <read_six_numbers>     è¯»å…¥ 6 ä¸ªå€¼ï¼Œä¿å­˜è‡³ä» %rsi å¼€å§‹çš„åœ°å€

   0x000000000040110b <+23>:    mov    %rsp,%r14
   0x000000000040110e <+26>:    mov    $0x0,%r12d                      %r12 ç½® 0, å¹¶ä¸” %r13 %r14 %rbp å‡å’Œ %rsp æŒ‡å‘ç›¸åŒåœ°å€ 0x7fffffffe270

   0x0000000000401114 <+32>:    mov    %r13,%rbp
   0x0000000000401117 <+35>:    mov    0x0(%r13),%eax                  å°†ç¬¬ %r13 æŒ‡å‘çš„è¾“å…¥æ•°å¤åˆ¶åˆ° %eax
   0x000000000040111b <+39>:    sub    $0x1,%eax                       å°†è¾“å…¥æ•°å‡ 1
   0x000000000040111e <+42>:    cmp    $0x5,%eax                       åˆ¤æ–­è¾“å…¥æ•°æ˜¯å¦å°äºç­‰äº 6, å› ä¸ºä¸Šä¸€æ­¥ä¸­å‡ 1 æ“ä½œ
   0x0000000000401121 <+45>:    jbe    0x401128 <phase_6+52>           è‹¥å¤§äº 6, åˆ™è°ƒç”¨ explode_bomb
   0x0000000000401123 <+47>:    callq  0x40143a <explode_bomb>
=========================================================================================================================================================
   0x0000000000401128 <+52>:    add    $0x1,%r12d                      å°† %r12 åŠ  1
   0x000000000040112c <+56>:    cmp    $0x6,%r12d                      åˆ¤æ–­ %r12 æ˜¯å¦ç­‰äº 6
   0x0000000000401130 <+60>:    je     0x401153 <phase_6+95>           è‹¥ç­‰äº 6, è·³è½¬ï¼Œå¦åˆ™ç»§ç»­æ‰§è¡Œ
   0x0000000000401132 <+62>:    mov    %r12d,%ebx                      å°† %r12 å¤åˆ¶åˆ° %ebx

   0x0000000000401135 <+65>:    movslq %ebx,%rax                       å°† %ebx ç¬¦å·ä½æ‰©å±•å¤åˆ¶åˆ° %rax
   0x0000000000401138 <+68>:    mov    (%rsp,%rax,4),%eax              å°†ç¬¬ %ebx è¾“å…¥æ•°å¤åˆ¶åˆ° %eax
   0x000000000040113b <+71>:    cmp    %eax,0x0(%rbp)                  æ¯”è¾ƒ %r13 æŒ‡å‘çš„è¾“å…¥æ•°å’Œ ç¬¬ %ebx è¾“å…¥æ•° æ˜¯å¦ç›¸ç­‰
   0x000000000040113e <+74>:    jne    0x401145 <phase_6+81>           å¦‚æœç›¸ç­‰ï¼Œåˆ™è°ƒç”¨ explode_bomb
   0x0000000000401140 <+76>:    callq  0x40143a <explode_bomb>
   0x0000000000401145 <+81>:    add    $0x1,%ebx                       å°† %ebx åŠ  1
   0x0000000000401148 <+84>:    cmp    $0x5,%ebx                       åˆ¤æ–­ %ebx æ˜¯å¦å°äºç­‰äº 5
   0x000000000040114b <+87>:    jle    0x401135 <phase_6+65>           è‹¥å°äºç­‰äºï¼Œè·³è½¬ï¼Œå¦åˆ™ç»§ç»­æ‰§è¡Œï¼›è¯¥å¾ªç¯åˆ¤æ–­ %r13 æŒ‡å‘çš„æ•°æ®å’Œå…¶åè¾“å…¥æ•°ä¸ç›¸ç­‰

   0x000000000040114d <+89>:    add    $0x4,%r13                       å°† %r13 æŒ‡å‘ä¸‹ä¸€ä¸ªè¾“å…¥æ•°ï¼Œè¯¥å¾ªç¯åˆ¤æ–­æ‰€æœ‰çš„è¾“å…¥æ•°å…¨éƒ¨ä¸ç›¸ç­‰
   0x0000000000401151 <+93>:    jmp    0x401114 <phase_6+32>
=========================================================================================================================================================
   0x0000000000401153 <+95>:    lea    0x18(%rsp),%rsi                 å°† %rsi æŒ‡å‘æ ˆä¸­è·³è¿‡è¯»å…¥æ•°æ®ä½ç½®ä½œä¸ºç»“æŸæ ‡è®°ï¼Œå¹¶ä¸” %r14 ä»å’Œ %rsp æŒ‡å‘åŒä¸€ä¸ªä½ç½®
   0x0000000000401158 <+100>:   mov    %r14,%rax                       å°† %r14 å¤åˆ¶åˆ° %rax
   0x000000000040115b <+103>:   mov    $0x7,%ecx
   0x0000000000401160 <+108>:   mov    %ecx,%edx                       å°†ç«‹å³æ•° 0x7 å¤åˆ¶åˆ° %edx
   0x0000000000401162 <+110>:   sub    (%rax),%edx                     ç«‹å³æ•° 7 å‡å» %r14 æŒ‡å‘çš„æ•°æ®
   0x0000000000401164 <+112>:   mov    %edx,(%rax)                     å°† 7 å‡çš„ç»“æœå­˜å› %r14 æ‰§è¡Œçš„å†…å­˜å•å…ƒ
   0x0000000000401166 <+114>:   add    $0x4,%rax                       %rax æŒ‡å‘ä¸‹ä¸€ä¸ªè¾“å…¥æ•°
   0x000000000040116a <+118>:   cmp    %rsi,%rax                       æ¯”è¾ƒæ˜¯å¦è¾¾åˆ°è¾“å…¥æ•°ç»„çš„æœ«å°¾ï¼Œ
   0x000000000040116d <+121>:   jne    0x401160 <phase_6+108>          è¯¥å¾ªç¯ä½¿ç”¨ç«‹å³æ•° 7 å‡å»æ¯ä¸ªè¾“å…¥æ•°æ®
==========================================================================================================================================================
   0x000000000040116f <+123>:   mov    $0x0,%esi                       å°† %rsi ç½® 0
   0x0000000000401174 <+128>:   jmp    0x401197 <phase_6+163>

   0x0000000000401176 <+130>:   mov    0x8(%rdx),%rdx                  å°† 0x8(%rdx) æŒ‡å‘å†…å­˜å•å…ƒçš„å†…å®¹å¤åˆ¶åˆ° %rdx, æŒ‡å‘é“¾è¡¨ä¸‹ä¸€ä¸ªå…ƒç´ 
   0x000000000040117a <+134>:   add    $0x1,%eax                       å°† %eax åŠ  1
   0x000000000040117d <+137>:   cmp    %ecx,%eax                       æ¯”è¾ƒ %ecx å’Œ %eax æ˜¯å¦ç›¸ç­‰
   0x000000000040117f <+139>:   jne    0x401176 <phase_6+130>          ä¸ç›¸ç­‰ï¼Œç»§ç»­éå†é“¾è¡¨ï¼Œæœ€ç»ˆ %rdx æŒ‡å‘é“¾è¡¨çš„ç¬¬ %ecx ä¸ªèŠ‚ç‚¹
   0x0000000000401181 <+141>:   jmp    0x401188 <phase_6+148>
   0x0000000000401183 <+143>:   mov    $0x6032d0,%edx                  é‡ç½®é“¾è¡¨é¦–åœ°å€
   0x0000000000401188 <+148>:   mov    %rdx,0x20(%rsp,%rsi,2)
   0x000000000040118d <+153>:   add    $0x4,%rsi
   0x0000000000401191 <+157>:   cmp    $0x18,%rsi
   0x0000000000401195 <+161>:   je     0x4011ab <phase_6+183>

   0x0000000000401197 <+163>:   mov    (%rsp,%rsi,1),%ecx              å°† (%rsp + %rsi) æŒ‡å‘çš„æ•°æ®å¤åˆ¶åˆ° %ecx
   0x000000000040119a <+166>:   cmp    $0x1,%ecx                       æ¯”è¾ƒ %ecx æ˜¯å¦å°äºç­‰äº 1
   0x000000000040119d <+169>:   jle    0x401183 <phase_6+143>          è‹¥å°äºç­‰äºï¼Œè·³è½¬ï¼Œå¦åˆ™ç»§ç»­æ‰§è¡Œï¼Œç­‰äº 1, %edx ç›´æ¥æŒ‡å‘é“¾è¡¨é¦–åœ°å€
   0x000000000040119f <+171>:   mov    $0x1,%eax                       å°† %eax ç½® 1
   0x00000000004011a4 <+176>:   mov    $0x6032d0,%edx                  å°† %rdx æŒ‡å‘å†…å­˜å•å…ƒ 0x6032d0
   0x00000000004011a9 <+181>:   jmp    0x401176 <phase_6+130>          è·³è½¬ï¼›è¯¥å¾ªç¯æ ¹æ®è¾“å…¥æ•°å°†é“¾è¡¨ä¸­å¯¹åº”çš„ç¬¬è¾“å…¥æ•°ä¸ªèŠ‚ç‚¹çš„åœ°å€å¤åˆ¶åˆ° 0x20(%rsp) å¼€å§‹çš„æ ˆä¸­
 ==========================================================================================================================================================
   0x00000000004011ab <+183>:   mov    0x20(%rsp),%rbx                 å°† 0x20(%rsp) çš„é“¾è¡¨èŠ‚ç‚¹åœ°å€å¤åˆ¶åˆ° %rbx
   0x00000000004011b0 <+188>:   lea    0x28(%rsp),%rax                 å°† %rax æŒ‡å‘æ ˆä¸­ä¸‹ä¸€ä¸ªé“¾è¡¨èŠ‚ç‚¹çš„åœ°å€
   0x00000000004011b5 <+193>:   lea    0x50(%rsp),%rsi                 å°† %rsi æŒ‡å‘ä¿å­˜çš„é“¾è¡¨èŠ‚ç‚¹åœ°å€çš„æœ«å°¾
   0x00000000004011ba <+198>:   mov    %rbx,%rcx

   0x00000000004011bd <+201>:   mov    (%rax),%rdx
   0x00000000004011c0 <+204>:   mov    %rdx,0x8(%rcx)                  å°†æ ˆä¸­æŒ‡å‘çš„åä¸€ä¸ªèŠ‚ç‚¹çš„åœ°å€å¤åˆ¶åˆ°å‰ä¸€ä¸ªèŠ‚ç‚¹çš„åœ°å€ä½ç½®
   0x00000000004011c4 <+208>:   add    $0x8,%rax                       ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
   0x00000000004011c8 <+212>:   cmp    %rsi,%rax                       åˆ¤æ–­ 6 ä¸ªèŠ‚ç‚¹æ˜¯å¦éå†å®Œæ¯•
   0x00000000004011cb <+215>:   je     0x4011d2 <phase_6+222>
   0x00000000004011cd <+217>:   mov    %rdx,%rcx
   0x00000000004011d0 <+220>:   jmp    0x4011bd <phase_6+201>
   0x00000000004011d2 <+222>:   movq   $0x0,0x8(%rdx)                  è¯¥å¾ªç¯æŒ‰ç…§ 7 å‡å»è¾“å…¥æ•°æ®çš„ç´¢å¼•é‡æ–°è°ƒæ•´é“¾è¡¨
==========================================================================================================================================================
   0x00000000004011da <+230>:   mov    $0x5,%ebp
   0x00000000004011df <+235>:   mov    0x8(%rbx),%rax                  å°† %rax æŒ‡å‘ %rbx ä¸‹ä¸€ä¸ªé“¾è¡¨èŠ‚ç‚¹
   0x00000000004011e3 <+239>:   mov    (%rax),%eax
   0x00000000004011e5 <+241>:   cmp    %eax,(%rbx)                     æ¯”è¾ƒé“¾è¡¨èŠ‚ç‚¹ä¸­ç¬¬ä¸€ä¸ªå­—æ®µå€¼çš„å¤§å°ï¼Œå¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹å€¼å¤§äºåä¸€ä¸ªèŠ‚ç‚¹å€¼ï¼Œè·³è½¬
   0x00000000004011e7 <+243>:   jge    0x4011ee <phase_6+250>
   0x00000000004011e9 <+245>:   callq  0x40143a <explode_bomb>
   0x00000000004011ee <+250>:   mov    0x8(%rbx),%rbx                  å°† %rbx å‘åç§»åŠ¨ï¼ŒæŒ‡å‘æ ˆä¸­ä¸‹ä¸€ä¸ªé“¾è¡¨èŠ‚ç‚¹çš„åœ°å€
   0x00000000004011f2 <+254>:   sub    $0x1,%ebp                       åˆ¤æ–­å¾ªç¯æ˜¯å¦ç»“æŸï¼Œè¯¥å¾ªç¯åˆ¤æ–­æ ˆä¸­é‡æ–°è°ƒæ•´åçš„é“¾è¡¨èŠ‚ç‚¹æ˜¯å¦æŒ‰ç…§é™åºæ’åˆ—
   0x00000000004011f5 <+257>:   jne    0x4011df <phase_6+235>
   0x00000000004011f7 <+259>:   add    $0x50,%rsp
   0x00000000004011fb <+263>:   pop    %rbx
   0x00000000004011fc <+264>:   pop    %rbp
   0x00000000004011fd <+265>:   pop    %r12
   0x00000000004011ff <+267>:   pop    %r13
   0x0000000000401201 <+269>:   pop    %r14
   0x0000000000401203 <+271>:   retq
End of assembler dump.

(gdb) disas read_six_numbers
%rsi å­˜å‚¨è°ƒç”¨è€… phase_2 æ ˆå¸§çš„å±€éƒ¨å˜é‡å¼€å§‹åœ°å€
%rdx = %rsi + 0
%rcx = %rsi + 4
%r8 =  %rsi + 8
%r9 =  %rsi + 12
(%rsp)  = %rsi + 16
8(%rsp) = %rsi + 20
Dump of assembler code for function read_six_numbers:
   0x000000000040145c <+0>: sub    $0x18,%rsp
   0x0000000000401460 <+4>: mov    %rsi,%rdx
   0x0000000000401463 <+7>: lea    0x4(%rsi),%rcx
   0x0000000000401467 <+11>:    lea    0x14(%rsi),%rax
   0x000000000040146b <+15>:    mov    %rax,0x8(%rsp)
   0x0000000000401470 <+20>:    lea    0x10(%rsi),%rax
   0x0000000000401474 <+24>:    mov    %rax,(%rsp)
   0x0000000000401478 <+28>:    lea    0xc(%rsi),%r9
   0x000000000040147c <+32>:    lea    0x8(%rsi),%r8
   0x0000000000401480 <+36>:    mov    $0x4025c3,%esi
   0x0000000000401485 <+41>:    mov    $0x0,%eax
   0x000000000040148a <+46>:    callq  0x400bf0 <__isoc99_sscanf@plt>
   0x000000000040148f <+51>:    cmp    $0x5,%eax
   0x0000000000401492 <+54>:    jg     0x401499 <read_six_numbers+61>
   0x0000000000401494 <+56>:    callq  0x40143a <explode_bomb>
   0x0000000000401499 <+61>:    add    $0x18,%rsp
   0x000000000040149d <+65>:    retq
```
%rbp %rbx %r12~%15 è¢«è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨
%r10 %r11 è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨
%rdi %rsi %rdx %rcx %r8 %r9 ä¾æ¬¡ä¿å­˜è¾“å…¥æ•° 1~6

å‡è®¾è¾“å…¥æ•°æ®ä¸º 4 3 2 1 6 5

çŒœæµ‹ 0x6032d8 ä¸ºé“¾è¡¨é¦–åœ°å€ï¼Œé“¾è¡¨ä¸­æ¯ä¸ªèŠ‚ç‚¹å ç”¨ 12 ä¸ª Byte, å‰ 8 å­—èŠ‚ä¿å­˜ä¸¤ä¸ª 4 å­— Byte çš„æ•´å‹æ•°ï¼Œå‰©ä½™çš„ 4Byte å­˜æ”¾ä¸‹ä¸ªèŠ‚ç‚¹åœ°å€

GDB æŸ¥çœ‹ä½¿ç”¨ 7 å‡å»å¯¹åº”çš„è¾“å…¥åçš„æ•°æ®
(gdb) p /x $rsp
$1 = 0x7fffffffe270
(gdb) x/6dw 0x7fffffffe270
0x7fffffffe270: 3   4   5   6
0x7fffffffe280: 1   2

é‡æ–°è°ƒæ•´é“¾è¡¨å‰çš„é“¾è¡¨çš„ç»“æ„
(gdb) x/24xw 0x006032d0
0x6032d0 <node1>:   0x0000014c  0x00000001  0x006032e0  0x00000000
0x6032e0 <node2>:   0x000000a8  0x00000002  0x006032f0  0x00000000
0x6032f0 <node3>:   0x0000039c  0x00000003  0x00603300  0x00000000
0x603300 <node4>:   0x000002b3  0x00000004  0x00603310  0x00000000
0x603310 <node5>:   0x000001dd  0x00000005  0x00603320  0x00000000
0x603320 <node6>:   0x000001bb  0x00000006  0x00000000  0x00000000

ä¿å­˜åœ¨æ ˆä¸­é“¾è¡¨èŠ‚ç‚¹ä¿¡æ¯
(gdb) x/6xg 0x7fffffffe290
0x7fffffffe290: 0x00000000006032f0  0x0000000000603300
0x7fffffffe2a0: 0x0000000000603310  0x0000000000603320
0x7fffffffe2b0: 0x00000000006032d0  0x00000000006032e0

æŒ‰ç…§ 7 å‡å»å¯¹åº”çš„è¾“å…¥åé‡æ–°è°ƒæ•´é“¾è¡¨åçš„é“¾è¡¨ç»“æ„ï¼Œç´¢å¼•é¡ºåºä¸º 3 4 5 6 1 2
(gdb) x/24xw 0x006032d0
0x6032d0 <node1>:   0x0000014c  0x00000001  0x006032e0  0x00000000
0x6032e0 <node2>:   0x000000a8  0x00000002  0x00000000  0x00000000
0x6032f0 <node3>:   0x0000039c  0x00000003  0x00603300  0x00000000
0x603300 <node4>:   0x000002b3  0x00000004  0x00603310  0x00000000
0x603310 <node5>:   0x000001dd  0x00000005  0x00603320  0x00000000
0x603320 <node6>:   0x000001bb  0x00000006  0x006032d0  0x00000000

ç ´è§£æ€è·¯ï¼š
å°†é“¾è¡¨ä¸­æ¯ä¸ªèŠ‚ç‚¹æŒ‰ç…§å‰ 4 å­—èŠ‚é™åºæ’åº
3 4 5 6 1 2
å› ä¸ºåœ¨å‰é¢ä½¿ç”¨ 7 å‡å»å¯¹åº”çš„å€¼ï¼Œæ‰€ä»¥ç ´è§£å¯†ç 
4 3 2 1 6 5


## final

![csapp-bomb-lab-report-5](https://raw.githubusercontent.com/mbinary/mbinary.github.io/hexo/source/images/csapp-bomb-lab-report-5.png)


å•Šï¼Œç»ˆäºæ‹†é™¤ğŸ’£äº†ï¼Œ
â•°(*Â°â–½Â°*)â•¯
ç­‰ç­‰ï¼Œè¿˜æ¼äº†ä»€ä¹ˆ`? åœ¨ asm ä¸­ï¼Œå¯ä»¥çœ‹åˆ°è¿˜æœ‰ secret_phase è¿™ä¸ªå‡½æ•°ï¼Œå¯æ˜¯è¿™ä¸ªå‡½æ•°çš„è°ƒç”¨æ˜¯æœ‰æŠ€å·§çš„ï¼Œè¿½è¸ªå‘ç°æ˜¯åœ¨ phase_defused ä¸­è°ƒç”¨çš„ï¼ŒåŒæ ·ï¼ŒæŸ¥çœ‹å­—ç¬¦ä¸²ï¼Œå‘ç°æ¯”è¾ƒäº†"DrEvil", ä»¥åŠä¸€ä¸ªæ ¼å¼ä¸²"%d %d %s", å¯èƒ½æ˜¯ phase3,phase4 çš„æ•°å­—åŠ ä¸Š DrEvil è¾“å…¥. å¯æ˜¯æœ€åæˆ‘è¯•äº†å¾ˆå¤šæ¬¡éƒ½æ²¡æœ‰è¯•å‡ºæ¥ã€‚åæ¥å‘ç°æ˜¯æœ€åæ‰å‡ºç°ï¼Œé‚£æ˜¯ç¬¬ä¸ƒå…³ï¼Œæˆ‘ä»¥ä¸ºæ˜¯åœ¨è¾“å…¥ DrEvil å°±å‡ºç°ã€‚è€Œä¸”è¯•äº†æ˜¯åœ¨ç¬¬å››å…³å

æ–¹æ³•äºŒï¼Œgdb ä¸­è®¾ç½®æ–­ç‚¹'b phase_defused', ç„¶å`jump secret_phase`

![csapp-bomb-lab-report-6](https://raw.githubusercontent.com/mbinary/mbinary.github.io/hexo/source/images/csapp-bomb-lab-report-6.png)


æœ€åå¾—åˆ°ç­”æ¡ˆæ˜¯ 22



## summary
é€šè¿‡è¿™ä¸ª lab, å­¦åˆ°äº† gdb,objdump ç­‰å·¥å…·çš„ä½¿ç”¨ï¼Œå¯¹æ±‡ç¼–è¯­è¨€æ›´ç†Ÿæ‚‰ï¼Œå¯¹å‡½æ•°è°ƒç”¨ä¸­æ ˆå¸§çš„å˜åŒ–ï¼ŒåŠ¨æ€å˜é‡çš„ç†è§£æ›´åŠ æ·±åˆ»
ä¸å¾—ä¸ä½©æœå›½å¤–æ•™å­¦çš„è´¨é‡ï¼Œä»¥åŠè¿™ä¸ª lab çš„æœ‰è¶£ä¸å®ç”¨
